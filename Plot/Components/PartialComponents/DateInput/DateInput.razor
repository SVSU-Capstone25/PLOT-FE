@*
    Filename:- DateInput.razor
    Part of Project: Plot

    File Purpose:
    The purpose of this file is to create a date input element.

    Program Purpose:
    The purpose of PLOT is to allow users to easily create, manage,
    and allocate floorsets for Plato's Closet.

    Author: Andrew Kennedy (2/10/2025)
*@

@rendermode InteractiveServer
@inherits LayoutComponentBase
@inject IJSRuntime JS

<div class="DateInput @Class " id="@Id">
    <div class="form-floating mt-3 custom-date-wrapper">
        <input type="date" class="date-input form-control custom-date-input @invalidClass" 
                                                id="date-input" value="@(DateTime.Today.ToString("yyyy-MM-dd"))" @onchange="HandleDateChange"  />
        <i class="fa-regular fa-calendar custom-calendar-icon" @onclick="OpenDatePicker"></i>

        <label for="date-input" class="inner-date-label @invalidClass">
            @* If the date is valid, keep the label text the same *@            
            @* Otherwise, inform the user of the invalid date *@
            @(isValid ? Label : "Invalid Date!")
        </label>
    </div> 
    
    <label for="date-input" class="date-format-label">MM/DD/YYYY</label>
</div>

<script>
    window.openDatePicker = function () {
        // Show the date picker when the date input label is clicked
        document.querySelector("#date-input").showPicker();
    };



</script>

@code 
{
    [Parameter]
    public string? Class { get; set; }

    [Parameter]
    public string? Id { get; set; }

    [Parameter]
    public string? Label { get; set; }

    // Used to send the date to the parent
    [Parameter]
    public EventCallback<DateTime?> ValueChanged { get; set; }   

    [Parameter]
    public DateTime? Value { get; set; }

    private string invalidClass;


    private bool isValid = true;

    /* After the component receives its parameters, initialize the selectedDateTime */
    protected override void OnParametersSet()
    {
        // If value has not been set, default to the current date
        if (Value == default) {
            Value = DateTime.Today; // Convert DateOnly to DateTime
        }
    }
    

    /*
        The HandleDateChange function sends the date to the parent whenever the
        user changes the input text.
    */
    private async Task HandleDateChange(ChangeEventArgs e)
    {
        // If the value successfully parses, initialize a new DateTime object
        if (DateTime.TryParse(e.Value?.ToString(), out DateTime newDateTime))
        {            
            isValid = true;
            invalidClass = "";
            Value = newDateTime;             
        }
        else
        {            
            isValid = false;
            invalidClass = "error";         
            Value = null;   
        }

        // Send the value to the parent
        await ValueChanged.InvokeAsync(Value);
        

    }


    /* 
        The OpenDatePicker function invokes a JS script to open 
        the date input's DatePicker.
    */
    private void OpenDatePicker()
    {
        JS.InvokeVoidAsync("openDatePicker");
    }

  

}
